<!DOCTYPE html>
<html>
<head>
    <title>AREA Demo</title>
    <style>
        body {
            background-color: black;
            color: white;
            font-family: Arial, sans-serif;
            padding: 50px;
        }
        button {
            background-color: white;
            color: black;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
        }
        button:hover {
            background-color: #ddd;
        }
        input, select, textarea {
            padding: 10px;
            font-size: 16px;
            margin: 10px;
            width: 300px;
        }
        textarea {
            height: 100px;
        }
        #status {
            margin: 20px 10px;
            font-size: 14px;
        }
        .section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid white;
        }
        .workflow-item {
            border: 1px solid #666;
            padding: 10px;
            margin: 10px;
        }
    </style>
</head>
<body>
    <h1>AREA Demo</h1>

    <div id="login-section">
        <h3>Login with Username/Password</h3>
        <input type="text" id="username" placeholder="Username" value="admin">
        <input type="password" id="password" placeholder="Password" value="Admin123!">
        <button onclick="login()">Login</button>

        <h3>Or Login with OAuth</h3>
        <button onclick="loginWithGoogle()" style="background-color: #4285f4; color: white;">
            Login with Google
        </button>
        <button onclick="loginWithFacebook()" style="background-color: #1877f2; color: white;">
            Login with Facebook
        </button>
    </div>

    <div id="main-section" style="display: none;">
        <!-- Connections -->
        <div class="section">
            <h2>Connections</h2>
            <button onclick="connectGmail()">Connect Gmail</button>
            <button onclick="connectFacebook()">Connect Facebook</button>
            <button onclick="connectGitHub()">Connect GitHub</button>
            <button onclick="connectSpotify()">Connect Spotify</button>
            <button onclick="checkConnections()">Check Connections</button>
        </div>

        <!-- Create Workflow -->
        <div class="section">
            <h2>Create Workflow</h2>
            <input type="text" id="workflow-name" placeholder="Workflow Name">
            <br>
            <select id="action-select" onchange="actionChanged()">
                <option value="">Select Action...</option>
            </select>
            <div id="action-config"></div>
            <br>
            <select id="reaction-select" onchange="reactionChanged()">
                <option value="">Select Reaction...</option>
            </select>
            <div id="reaction-config"></div>
            <br>
            <button onclick="createWorkflow()">Create Workflow</button>
        </div>

        <!-- View Workflows -->
        <div class="section">
            <h2>My Workflows</h2>
            <button onclick="loadWorkflows()">Refresh</button>
            <div id="workflows-list"></div>
        </div>

        <button onclick="logout()">Logout</button>
    </div>

    <div id="status"></div>

    <script>
        const BASE_URL = 'http://localhost:8080';
        let token = localStorage.getItem('jwt_token');
        let services = [];
        let selectedAction = null;
        let selectedReaction = null;

        if (token) {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('main-section').style.display = 'block';
            loadServices();
        }

        function showStatus(message) {
            document.getElementById('status').innerText = message;
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, password})
                });

                const data = await response.json();

                if (response.ok) {
                    token = data.token;
                    localStorage.setItem('jwt_token', token);
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('main-section').style.display = 'block';
                    showStatus('Logged in successfully');
                    loadServices();
                } else {
                    showStatus('Login failed: ' + data.error);
                }
            } catch (error) {
                showStatus('Error: ' + error.message);
            }
        }

        async function loadServices() {
            try {
                const response = await fetch(`${BASE_URL}/api/services`, {
                    headers: {'Authorization': `Bearer ${token}`}
                });
                const data = await response.json();

                if (response.ok) {
                    services = data.services;
                    populateDropdowns();
                }
            } catch (error) {
                showStatus('Error loading services: ' + error.message);
            }
        }

        function populateDropdowns() {
            const actionSelect = document.getElementById('action-select');
            const reactionSelect = document.getElementById('reaction-select');

            actionSelect.innerHTML = '<option value="">Select Action...</option>';
            reactionSelect.innerHTML = '<option value="">Select Reaction...</option>';

            services.forEach(service => {
                service.actions.forEach(action => {
                    const option = document.createElement('option');
                    option.value = action.id;
                    option.textContent = `${service.display_name}: ${action.display_name}`;
                    option.dataset.schema = JSON.stringify(action.config_schema);
                    actionSelect.appendChild(option);
                });

                service.reactions.forEach(reaction => {
                    const option = document.createElement('option');
                    option.value = reaction.id;
                    option.textContent = `${service.display_name}: ${reaction.display_name}`;
                    option.dataset.schema = JSON.stringify(reaction.config_schema);
                    reactionSelect.appendChild(option);
                });
            });
        }

        function actionChanged() {
            const select = document.getElementById('action-select');
            const option = select.options[select.selectedIndex];

            if (!option.value) {
                document.getElementById('action-config').innerHTML = '';
                return;
            }

            selectedAction = {
                id: option.value,
                schema: JSON.parse(option.dataset.schema)
            };

            renderConfigForm('action-config', selectedAction.schema);
        }

        function reactionChanged() {
            const select = document.getElementById('reaction-select');
            const option = select.options[select.selectedIndex];

            if (!option.value) {
                document.getElementById('reaction-config').innerHTML = '';
                return;
            }

            selectedReaction = {
                id: option.value,
                schema: JSON.parse(option.dataset.schema)
            };

            renderConfigForm('reaction-config', selectedReaction.schema);
        }

        function renderConfigForm(containerId, schema) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (!schema || !schema.properties) return;

            Object.keys(schema.properties).forEach(key => {
                const prop = schema.properties[key];
                const label = document.createElement('label');
                label.textContent = key + ': ';

                let input;
                if (prop.type === 'string' && prop.maxLength > 200) {
                    input = document.createElement('textarea');
                } else {
                    input = document.createElement('input');
                    input.type = 'text';
                }

                input.id = `${containerId}-${key}`;
                input.placeholder = prop.description || key;

                container.appendChild(document.createElement('br'));
                container.appendChild(label);
                container.appendChild(input);
            });
        }

        function getConfigValues(containerId, schema) {
            const config = {};

            if (!schema || !schema.properties) return config;

            Object.keys(schema.properties).forEach(key => {
                const input = document.getElementById(`${containerId}-${key}`);
                if (input) {
                    config[key] = input.value;
                }
            });

            return config;
        }

        async function createWorkflow() {
            const name = document.getElementById('workflow-name').value;

            if (!name || !selectedAction || !selectedReaction) {
                showStatus('Please fill in all fields');
                return;
            }

            const actionConfig = getConfigValues('action-config', selectedAction.schema);
            const reactionConfig = getConfigValues('reaction-config', selectedReaction.schema);

            const workflowData = {
                name: name,
                action_id: parseInt(selectedAction.id),
                reaction_id: parseInt(selectedReaction.id),
                action_config: actionConfig,
                reaction_config: reactionConfig,
                is_active: true
            };

            try {
                const response = await fetch(`${BASE_URL}/api/areas`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(workflowData)
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus('Workflow created successfully!');
                    document.getElementById('workflow-name').value = '';
                    loadWorkflows();
                } else {
                    showStatus('Error: ' + data.error);
                }
            } catch (error) {
                showStatus('Error: ' + error.message);
            }
        }

        async function loadWorkflows() {
            try {
                const response = await fetch(`${BASE_URL}/api/areas`, {
                    headers: {'Authorization': `Bearer ${token}`}
                });

                const data = await response.json();

                if (response.ok) {
                    displayWorkflows(data.areas);
                } else {
                    showStatus('Error: ' + data.error);
                }
            } catch (error) {
                showStatus('Error: ' + error.message);
            }
        }

        function displayWorkflows(workflows) {
            const container = document.getElementById('workflows-list');
            container.innerHTML = '';

            if (workflows.length === 0) {
                container.innerHTML = '<p>No workflows yet</p>';
                return;
            }

            workflows.forEach(workflow => {
                const div = document.createElement('div');
                div.className = 'workflow-item';
                div.innerHTML = `
                    <strong>${workflow.name}</strong> - ${workflow.is_active ? 'Active' : 'Inactive'}
                    <br>Action: ${workflow.action.service} - ${workflow.action.display_name}
                    <br>Reaction: ${workflow.reaction.service} - ${workflow.reaction.display_name}
                    <button onclick="deleteWorkflow(${workflow.id})">Delete</button>
                `;
                container.appendChild(div);
            });
        }

        async function deleteWorkflow(id) {
            if (!confirm('Delete this workflow?')) return;

            try {
                const response = await fetch(`${BASE_URL}/api/areas/${id}`, {
                    method: 'DELETE',
                    headers: {'Authorization': `Bearer ${token}`}
                });

                if (response.ok) {
                    showStatus('Workflow deleted');
                    loadWorkflows();
                } else {
                    showStatus('Error deleting workflow');
                }
            } catch (error) {
                showStatus('Error: ' + error.message);
            }
        }

        function connectGmail() {
            if (!token) {
                showStatus('Please login first');
                return;
            }
            window.location.href = `${BASE_URL}/api/connections/gmail?token=${token}`;
        }

        function connectFacebook() {
            if (!token) {
                showStatus('Please login first');
                return;
            }
            window.location.href = `${BASE_URL}/api/connections/facebook?token=${token}`;
        }

        function connectGitHub() {
            if (!token) {
                showStatus('Please login first');
                return;
            }
            window.location.href = `${BASE_URL}/api/connections/github?token=${token}`;
        }

        function connectSpotify() {
            if (!token) {
                showStatus('Please login first');
                return;
            }
            window.location.href = `${BASE_URL}/api/connections/spotify?token=${token}`;
        }

        async function checkConnections() {
            if (!token) {
                showStatus('Please login first');
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/api/connections`, {
                    headers: {'Authorization': `Bearer ${token}`}
                });

                const data = await response.json();

                if (response.ok) {
                    const connections = data.connections
                        .filter(c => c.is_connected)
                        .map(c => c.service_name)
                        .join(', ');
                    showStatus('Connected: ' + (connections || 'None'));
                } else {
                    showStatus('Error: ' + data.error);
                }
            } catch (error) {
                showStatus('Error: ' + error.message);
            }
        }

        function logout() {
            localStorage.removeItem('jwt_token');
            token = null;
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('main-section').style.display = 'none';
            showStatus('Logged out');
        }

        function loginWithGoogle() {
            window.location.href = `${BASE_URL}/api/auth/google/login`;
        }

        function loginWithFacebook() {
            window.location.href = `${BASE_URL}/api/auth/facebook/login`;
        }
    </script>
</body>
</html>
